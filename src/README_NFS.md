# eBPF å¢å¼ºçš„ NFS æœåŠ¡å™¨

æœ¬é¡¹ç›®å®ç°äº†ä¸€ä¸ªåŸºäº eBPF æŠ€æœ¯çš„é«˜æ€§èƒ½ NFSï¼ˆç½‘ç»œæ–‡ä»¶ç³»ç»Ÿï¼‰æœåŠ¡å™¨ï¼Œèƒ½å¤Ÿåœ¨å†…æ ¸ç©ºé—´ç›´æ¥å¤„ç†ç®€å•çš„ NFS è¯·æ±‚ï¼Œæ˜¾è‘—æå‡æœåŠ¡æ€§èƒ½ã€‚

## é¡¹ç›®æ¦‚è¿°

è¯¥é¡¹ç›®åˆ©ç”¨ eBPF (Extended Berkeley Packet Filter) åœ¨å†…æ ¸ç©ºé—´æ‹¦æˆªå’Œå¤„ç† NFS è¯·æ±‚ã€‚å¯¹äºç®€å•çš„æ–‡ä»¶æ“ä½œï¼ˆå¦‚ GETATTRã€READ å°æ–‡ä»¶ï¼‰ï¼ŒæœåŠ¡å™¨èƒ½å¤Ÿå®Œå…¨ç»•è¿‡ç”¨æˆ·ç©ºé—´å¤„ç†ï¼Œç›´æ¥åœ¨å†…æ ¸ä¸­å®Œæˆå“åº”ï¼Œä»è€Œå¤§å¹…é™ä½å»¶è¿Ÿå¹¶æé«˜ååé‡ã€‚

### ğŸš€ æ ¸å¿ƒç‰¹æ€§

- **å†…æ ¸ç©ºé—´å¤„ç†**: ç®€å• NFS è¯·æ±‚åœ¨å†…æ ¸ç©ºé—´ç›´æ¥å¤„ç†ï¼Œé¿å…ç”¨æˆ·æ€åˆ‡æ¢å¼€é”€
- **æ™ºèƒ½è·¯ç”±**: ç®€å•è¯·æ±‚èµ°å†…æ ¸ï¼Œå¤æ‚è¯·æ±‚è‡ªåŠ¨é™çº§åˆ°ç”¨æˆ·ç©ºé—´
- **é«˜æ€§èƒ½ç¼“å­˜**: æ–‡ä»¶å±æ€§å’Œå°æ–‡ä»¶å†…å®¹è‡ªåŠ¨ç¼“å­˜åˆ°å†…æ ¸å†…å­˜ä¸­
- **NFS v3 æ”¯æŒ**: å…¼å®¹æ ‡å‡† NFS v3 åè®®
- **å®‰å…¨æ€§å¢å¼º**: åˆ©ç”¨ eBPF çš„å®‰å…¨ç‰¹æ€§è¿›è¡Œè®¿é—®æ§åˆ¶
- **å®æ—¶ç›‘æ§**: ä¸°å¯Œçš„æ€§èƒ½æŒ‡æ ‡å’Œå®æ—¶ç»Ÿè®¡
- **é›¶æ‹·è´ä¼˜åŒ–**: æœ€å°åŒ–æ•°æ®åœ¨å†…æ ¸å’Œç”¨æˆ·ç©ºé—´ä¹‹é—´çš„æ‹·è´

### ğŸ“Š æ€§èƒ½ä¼˜åŠ¿

- âš¡ **å»¶è¿Ÿé™ä½**: æ¶ˆé™¤å†…æ ¸-ç”¨æˆ·ç©ºé—´ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€
- ğŸš€ **ååé‡æå‡**: å†…æ ¸ç›´æ¥å¤„ç†ç®€å•è¯·æ±‚
- ğŸ’¾ **å†…å­˜æ•ˆç‡**: è·¨è¿›ç¨‹å…±äº«çš„å†…æ ¸ç¼“å­˜
- ğŸ“ˆ **CPU ä½¿ç”¨ç‡é™ä½**: å‡å°‘æ–‡ä»¶ç³»ç»Ÿæ“ä½œçš„å¤„ç†å¼€é”€
- ğŸ”§ **å¹¶å‘å¤„ç†èƒ½åŠ›**: æ”¯æŒæ›´å¤šå¹¶å‘ NFS å®¢æˆ·ç«¯

## æ¶æ„è®¾è®¡

### ç³»ç»Ÿæ¶æ„å›¾

```
NFS è¯·æ±‚ â†’ TC Ingress (eBPF) â†’ è§£æ RPC â†’ æ£€æŸ¥å†…æ ¸ç¼“å­˜
     â†“                                          â†“
ç¼“å­˜å‘½ä¸­ â† ç›´æ¥å“åº” â† å†…æ ¸ç©ºé—´å¤„ç†          ç¼“å­˜æœªå‘½ä¸­
     â†“                                          â†“
  å“åº”å®¢æˆ·ç«¯                               è½¬å‘åˆ°ç”¨æˆ·ç©ºé—´
                                                 â†“
                                          æ–‡ä»¶ç³»ç»Ÿè¯»å– â†’ æ›´æ–°ç¼“å­˜
                                                 â†“
                                              å“åº”å®¢æˆ·ç«¯
```

### è¯¦ç»†ç»„ä»¶è¯´æ˜

1. **eBPF TC ç¨‹åº (nfs_server.bpf.c)**
   - æ‹¦æˆª UDP 2049 ç«¯å£çš„ NFS æ•°æ®åŒ…
   - è§£æ RPC åè®®å¤´
   - å¤„ç†ç®€å•çš„ NFS æ“ä½œï¼ˆGETATTRã€READï¼‰
   - ç®¡ç†å†…æ ¸ç¼“å­˜

2. **ç”¨æˆ·ç©ºé—´ NFS æœåŠ¡å™¨ (nfs_server.c)**
   - å¤„ç†å¤æ‚çš„ NFS æ“ä½œ
   - ç®¡ç†æ–‡ä»¶ç³»ç»Ÿè®¿é—®
   - ç»´æŠ¤ç¼“å­˜ä¸€è‡´æ€§
   - æä¾›ç›‘æ§å’Œç»Ÿè®¡

3. **å†…æ ¸ç¼“å­˜ç³»ç»Ÿ**
   - æ–‡ä»¶å±æ€§ç¼“å­˜ï¼ˆå…ƒæ•°æ®ï¼‰
   - å°æ–‡ä»¶å†…å®¹ç¼“å­˜
   - æ–‡ä»¶å¥æŸ„åˆ°æ–‡ä»¶åæ˜ å°„
   - å®¢æˆ·ç«¯è¿æ¥çŠ¶æ€è·Ÿè¸ª

## æ”¯æŒçš„ NFS æ“ä½œ

### å†…æ ¸ç©ºé—´å¤„ç†çš„æ“ä½œï¼š
- **GETATTR**: è·å–æ–‡ä»¶å±æ€§ï¼ˆå¦‚æœå·²ç¼“å­˜ï¼‰
- **READ**: è¯»å–å°æ–‡ä»¶å†…å®¹ï¼ˆå¦‚æœå·²ç¼“å­˜ï¼‰

### ç”¨æˆ·ç©ºé—´å¤„ç†çš„æ“ä½œï¼š
- **WRITE**: å†™å…¥æ–‡ä»¶
- **CREATE**: åˆ›å»ºæ–‡ä»¶/ç›®å½•
- **REMOVE**: åˆ é™¤æ–‡ä»¶/ç›®å½•
- **LOOKUP**: æ–‡ä»¶åæŸ¥æ‰¾
- **READDIR**: ç›®å½•åˆ—è¡¨
- **SETATTR**: è®¾ç½®æ–‡ä»¶å±æ€§
- **å…¶ä»–å¤æ‚æ“ä½œ**

## ç¼–è¯‘å’Œè¿è¡Œ

### å‰ææ¡ä»¶

```bash
# Ubuntu/Debian
sudo apt-get install -y build-essential clang llvm libelf-dev libssl-dev pkg-config

# CentOS/RHEL
sudo yum install -y gcc clang llvm elfutils-libelf-devel openssl-devel pkgconfig
```

### ç¼–è¯‘

```bash
cd src
make nfs_server
```

### è¿è¡Œ

```bash
# ä»¥ root æƒé™è¿è¡Œï¼ˆeBPF éœ€è¦ï¼‰
sudo ./nfs_server -v -i ens33 -e ./nfs_exports -p 2049

# å‚æ•°è¯´æ˜ï¼š
# -v: è¯¦ç»†è¾“å‡º
# -i: ç½‘ç»œæ¥å£
# -e: NFS å¯¼å‡ºç›®å½•
# -p: NFS ç«¯å£ï¼ˆé»˜è®¤ 2049ï¼‰
# -n: ç¦ç”¨å†…æ ¸ç¼“å­˜
```
### åœæ­¢
```bash
# åœæ­¢ NFS æœåŠ¡å™¨
sudo pkill -f nfs_server

# æ¸…ç†TC
sudo tc filter del dev lo ingress
sudo tc filter del dev ens33 ingress
```
### æµ‹è¯•

```bash
# è¿è¡Œæµ‹è¯•è„šæœ¬
sudo ./test_nfs_server.sh

# æˆ–è€…å•ç‹¬æ„å»º
./test_nfs_server.sh build

# å¯åŠ¨æœåŠ¡å™¨
./test_nfs_server.sh start
```

## é…ç½®é€‰é¡¹

### å†…æ ¸é…ç½®å‚æ•°

- `enable_kernel_processing`: å¯ç”¨å†…æ ¸å¤„ç†ï¼ˆé»˜è®¤å¯ç”¨ï¼‰
- `max_cached_file_size`: æœ€å¤§ç¼“å­˜æ–‡ä»¶å¤§å°ï¼ˆé»˜è®¤ 4KBï¼‰
- `cache_ttl_seconds`: ç¼“å­˜ç”Ÿå­˜æ—¶é—´ï¼ˆé»˜è®¤ 300 ç§’ï¼‰

### è¿è¡Œæ—¶é…ç½®

```bash
# æŸ¥çœ‹ eBPF ç¨‹åºçŠ¶æ€
sudo bpftool prog list | grep nfs

# æŸ¥çœ‹æ˜ å°„å†…å®¹
sudo bpftool map list | grep nfs

# æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯
sudo bpftool map dump name nfs_stats
```

## ç›‘æ§å’Œè°ƒè¯•

### æ€§èƒ½æŒ‡æ ‡

æœåŠ¡å™¨æä¾›ä»¥ä¸‹ç»Ÿè®¡ä¿¡æ¯ï¼š
- æ€»è¯·æ±‚æ•°
- å†…æ ¸å¤„ç†çš„è¯·æ±‚æ•°
- ç”¨æˆ·ç©ºé—´å¤„ç†çš„è¯·æ±‚æ•°
- ç¼“å­˜å‘½ä¸­ç‡
- ç¼“å­˜æœªå‘½ä¸­æ•°
- é”™è¯¯æ•°é‡

### è°ƒè¯•ä¿¡æ¯

ä½¿ç”¨ `-v` å‚æ•°å¯ç”¨è¯¦ç»†æ—¥å¿—ï¼š
```bash
sudo ./nfs_server -v -i lo -e ./nfs_exports
```

### ä½¿ç”¨ bpftrace è¿›è¡Œé«˜çº§è°ƒè¯•

```bash
# è·Ÿè¸ª NFS è¯·æ±‚
sudo bpftrace -e 'tracepoint:syscalls:sys_enter_openat { printf("File opened: %s\n", str(args->filename)); }'

# ç›‘æ§ç½‘ç»œæµé‡
sudo bpftrace -e 'kprobe:udp_rcv { printf("UDP packet received\n"); }'
```

## å®‰å…¨æ€§

### eBPF å®‰å…¨ç‰¹æ€§

- **å†…å­˜å®‰å…¨**: eBPF ç¨‹åºç»è¿‡éªŒè¯å™¨æ£€æŸ¥ï¼Œç¡®ä¿å†…å­˜è®¿é—®å®‰å…¨
- **æƒé™æ§åˆ¶**: éœ€è¦ CAP_BPF æˆ– root æƒé™åŠ è½½ç¨‹åº
- **è¾¹ç•Œæ£€æŸ¥**: è‡ªåŠ¨è¿›è¡Œæ•°ç»„å’ŒæŒ‡é’ˆè¾¹ç•Œæ£€æŸ¥

### NFS å®‰å…¨å»ºè®®

- ä½¿ç”¨é˜²ç«å¢™é™åˆ¶è®¿é—®ç«¯å£ 2049
- é…ç½®é€‚å½“çš„æ–‡ä»¶ç³»ç»Ÿæƒé™
- è€ƒè™‘ä½¿ç”¨ NFSv4 å’Œ Kerberos è®¤è¯ï¼ˆæœªæ¥ç‰ˆæœ¬ï¼‰
- å®šæœŸæ›´æ–° eBPF ç¨‹åºå’Œå†…æ ¸

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **eBPF ç¨‹åºåŠ è½½å¤±è´¥**
   ```bash
   # æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬ï¼ˆéœ€è¦ >= 4.15ï¼‰
   uname -r
   
   # æ£€æŸ¥ eBPF æ”¯æŒ
   sudo bpftool feature
   ```

2. **æƒé™ä¸è¶³**
   ```bash
   # ç¡®ä¿ä»¥ root æƒé™è¿è¡Œ
   sudo ./nfs_server
   ```

3. **ç½‘ç»œæ¥å£ä¸å­˜åœ¨**
   ```bash
   # æ£€æŸ¥å¯ç”¨æ¥å£
   ip link show
   ```

4. **ç«¯å£è¢«å ç”¨**
   ```bash
   # æ£€æŸ¥ç«¯å£ä½¿ç”¨æƒ…å†µ
   sudo netstat -ulpn | grep 2049
   
   # æˆ–ä½¿ç”¨å…¶ä»–ç«¯å£
   sudo ./nfs_server -p 2050
   ```

### æ—¥å¿—åˆ†æ

æ£€æŸ¥ç³»ç»Ÿæ—¥å¿—ï¼š
```bash
# æŸ¥çœ‹å†…æ ¸æ—¥å¿—
sudo dmesg | grep -i bpf

# æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—
sudo journalctl -f | grep nfs
```

## æ€§èƒ½ä¼˜åŒ–

### è°ƒä¼˜å»ºè®®

1. **å¢åŠ ç¼“å­˜å¤§å°**ï¼šä¿®æ”¹æ˜ å°„å¤§å°ä»¥ç¼“å­˜æ›´å¤šæ–‡ä»¶
2. **è°ƒæ•´ TTL**ï¼šæ ¹æ®æ–‡ä»¶æ›´æ–°é¢‘ç‡è°ƒæ•´ç¼“å­˜ç”Ÿå­˜æ—¶é—´
3. **ç½‘ç»œä¼˜åŒ–**ï¼šä½¿ç”¨é«˜é€Ÿç½‘ç»œæ¥å£
4. **CPU äº²å’Œæ€§**ï¼šç»‘å®šè¿›ç¨‹åˆ°ç‰¹å®š CPU æ ¸å¿ƒ

### åŸºå‡†æµ‹è¯•

ä½¿ç”¨æ ‡å‡† NFS åŸºå‡†æµ‹è¯•å·¥å…·ï¼š
```bash
# å®‰è£… nfs-utils
sudo apt-get install nfs-utils

# æŒ‚è½½ NFS
sudo mount -t nfs 127.0.0.1:/path/to/export /mnt/nfs

# è¿è¡Œæ€§èƒ½æµ‹è¯•
dd if=/dev/zero of=/mnt/nfs/testfile bs=1M count=100
```

## æ‰©å±•å¼€å‘

### æ·»åŠ æ–°çš„ NFS æ“ä½œ

1. åœ¨ `nfs_server.h` ä¸­å®šä¹‰æ–°çš„è¿‡ç¨‹å¸¸é‡
2. åœ¨ `nfs_server.bpf.c` ä¸­æ·»åŠ å¤„ç†å‡½æ•°
3. åœ¨ `nfs_server.c` ä¸­å®ç°ç”¨æˆ·ç©ºé—´é€»è¾‘
4. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯å’Œç›‘æ§

### ç¤ºä¾‹ï¼šæ·»åŠ  LOOKUP æ“ä½œ

```c
// åœ¨ nfs_server.bpf.c ä¸­
static inline int handle_nfs_lookup(struct nfs_request *req, 
                                   struct nfs_event *event)
{
    // å®ç°æŸ¥æ‰¾é€»è¾‘
    return 0;
}
```

## è´¡çŒ®

æ¬¢è¿è´¡çŒ®ä»£ç å’ŒæŠ¥å‘Šé—®é¢˜ï¼è¯·éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š

1. Fork é¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
3. æäº¤æ›´æ”¹
4. åˆ›å»º Pull Request

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨åŒé‡è®¸å¯ï¼š
- GPL-2.0ï¼ˆå¯¹äºå†…æ ¸ eBPF ä»£ç ï¼‰
- LGPL-2.1 æˆ– BSD-2-Clauseï¼ˆå¯¹äºç”¨æˆ·ç©ºé—´ä»£ç ï¼‰

## ç›¸å…³èµ„æº

- [eBPF å®˜æ–¹æ–‡æ¡£](https://ebpf.io/)
- [NFS RFC 1813](https://tools.ietf.org/html/rfc1813)
- [Linux TC å­ç³»ç»Ÿ](https://man7.org/linux/man-pages/man8/tc.8.html)
- [libbpf æ–‡æ¡£](https://github.com/libbpf/libbpf)
